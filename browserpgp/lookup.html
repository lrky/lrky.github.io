<html>
  <head>
    <title>browserPGP | Lookup</title>
    <meta name="description" content="Lookup public PGP keys in browser, simple and secure." />
    <meta name="keywords" content="browserPGP,PGP,OpenPGP,online,browser,javascript,github,live,secure,key generator,key gen,encrypt,decrypt,sign,verify,signature">
    <link rel="icon" type='image/png' sizes='256x256' href="img/256.png"/>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="dark.css">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="js/copy.js"></script>
    <script src="js/prngCheck.js"></script>
    <script src="js/favicon.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/openpgp.min.js"></script>
    <script>
      let pubkey;
      async function encryptDecryptFunction() {
      document.getElementById("progressbar").className = "progress-bar progress-bar-striped progress-bar-animated";
      try {
        const query = document.getElementById("query").value;
        const server = (document.getElementById("server") && document.getElementById("server").value) || 'https://keyserver.ubuntu.com';
        const url = server.replace(/\/$/, '') + '/pks/lookup?op=get&options=mr&search=' + encodeURIComponent(query);
        const armoredPubkey = await fetch(url, { headers: { 'Accept': 'application/pgp-keys, text/plain' }
    }).then(r => r.text());
        document.getElementById("result").value = armoredPubkey;
        // Try to parse the key in the worker to show the first User ID
        try {
          const { userids } = await pgpClient.verify ? await pgpClient.parseKey({ armoredKey: armoredPubkey }) : { userids: [] };
        } catch (_) {}
        try {
          const parsed = await (pgpClient.parseKey ? pgpClient.parseKey({ armoredKey: armoredPubkey }) : Promise.resolve({ userids: [] }));
          const uid = (parsed.userids && parsed.userids[0]) || '';
          if (uid) document.getElementById("userid").value = uid;
        } catch (_e) {}
        document.getElementById("progressbar").className = "progress-bar bg-success";
      } catch (err) {
        document.getElementById("result").value = (err && err.message) ? err.message : String(err);
        document.getElementById("progressbar").className = "progress-bar bg-danger";
      }
    };
    
        let armoredPubkey = await hkp.lookup(options).catch((err) => {document.getElementById("result").value = err.message;document.getElementById("progressbar").className = "progress-bar bg-danger";});
        var pubkey = await openpgp.key.readArmored(armoredPubkey).catch((err) => {document.getElementById("result").value = err.message;document.getElementById("progressbar").className = "progress-bar bg-danger";});
        console.log(pubkey);
        if (pubkey) {
          document.getElementById("userid").value = pubkey.keys[0].users[0].userId.userid;
          document.getElementById("result").value = armoredPubkey;
          document.getElementById("progressbar").className = "progress-bar bg-success";
        } else {
          document.getElementById("result").value = 'Error, please try again.';
          document.getElementById("progressbar").className = "progress-bar bg-danger";
        }
      }
    </script>
    <style>
    html, body {
      height: 95%;
    }
    div.main {
      padding:20px;
      height: 100%;
    }
    </style>
  </head>
  <body>
    <div id="navbar-container"></div>
    <div class="main">
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm">
            <div class="form-group">
              <label for="exampleInputEmail1">Name / Email</label>
              <input type="text" class="form-control" id="query" placeholder="Enter name or email">
            </div>
            <div class="form-group progress">
              <div class="progress-bar" role="progressbar" id="progressbar" style="width: 100%"></div>
            </div>
            <button type="button" onclick="encryptDecryptFunction()" class="btn btn-primary">Lookup</button>
          </div>
          <div class="col-sm">
            <div class="form-group">
              <label for="exampleFormControlTextarea1">Public Key</label>
              <textarea class="form-control" style="font-size: 10px;" rows="20" placeholder="-----BEGIN PGP PUBLIC KEY BLOCK-----" id="result" readonly></textarea>
              <button type="button" style="margin-top: 1rem;" class="btn btn-primary" data-copy="#result">Copy</button>
            </div>
          </div>
          <div class="col-sm">
            <div class="form-group">
              <label for="exampleInputEmail1">User ID</label>
              <input type="text" class="form-control" id="userid" placeholder="Example Doe <example@gmail.com>" readonly>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
    async function encryptDecryptFunction() {
      const bar = document.getElementById("progressbar");
      bar.className = "progress-bar progress-bar-striped progress-bar-animated";
      try {
        const query = document.getElementById("query").value;
        const server = (document.getElementById("server") && document.getElementById("server").value) || 'https://keyserver.ubuntu.com';
        const url = server.replace(/\/$/, '') + '/pks/lookup?op=get&options=mr&search=' + encodeURIComponent(query);
        const armoredPubkey = await fetch(url, { headers: { 'Accept': 'application/pgp-keys, text/plain' } }).then(r => r.text());
        document.getElementById("result").value = armoredPubkey;
        try {
          const key = await openpgp.readKey({ armoredKey: armoredPubkey });
          const uids = (typeof key.getUserIDs === 'function') ? await key.getUserIDs() : [];
          if (uids && uids.length) document.getElementById("userid").value = uids[0];
        } catch (_) {}
        bar.className = "progress-bar bg-success";
      } catch (err) {
        document.getElementById("result").value = (err && err.message) ? err.message : String(err);
        bar.className = "progress-bar bg-danger";
      }
    }
    </script>
    <script>
    (function(){
      try {
        if (location.protocol === 'file:') {
          console.warn('[browserPGP] This page is opened via file://. Some browsers disable WebCrypto in this mode. Prefer http://localhost or HTTPS.');
        }
      } catch(_) {}
    })();
    </script>
  </body>
</html>
