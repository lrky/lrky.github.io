<!doctype html>
<html>
  <head>
    <title>browserPGP | Encrypt / Decrypt</title>
    <meta name="description" content="Encrypt and decrypt PGP in-browser on one page." />
    <meta name="keywords" content="browserPGP,PGP,OpenPGP,online,browser,javascript,github,live,secure,key generator,key gen,encrypt,decrypt,sign,verify,signature">
    <link rel="icon" type="image/png" sizes="256x256" href="img/256.png"/>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="dark.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="js/copy.js"></script>
    <script src="js/prngCheck.js"></script>
    <script src="js/favicon.js"></script>
    <script src="js/sha1.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/openpgp.min.js"></script>

    <style>
      html, body { height: 95%; }
      .main { padding: 20px; height: 100%; }
      .section-divider { margin: 1.25rem 0 1.75rem; border-top: 1px solid rgba(255,255,255,.1); }
      .block-label { font-weight: 600; margin-bottom: .25rem; }
      .mini-hint { font-size: 12px; opacity: .8; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="/">
        <img src="img/logo.svg" width="30" height="30" class="d-inline-block align-top" alt="">
        browserPGP
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="index.html">About</a></li>
          <li class="nav-item"><a class="nav-link" href="gen.html">Key Generator</a></li>
          <li class="nav-item"><a class="nav-link" href="pgp.html">Encrypt / Decrypt</a></li>
          <li class="nav-item"><a class="nav-link" href="sign.html">Sign</a></li>
          <li class="nav-item"><a class="nav-link" href="verify.html">Verify</a></li>
        </ul>
      </div>
    </nav>

    <div class="main container-fluid">

      <!-- Row: ENCRYPT -->
      <div class="row">
        <div class="col-12">
          <h5>Encrypt</h5>
          <div class="mini-hint">Provide a recipient public key and your plaintext. Output is an armored PGP message.</div>
          <div class="section-divider"></div>
        </div>

        <div class="col-sm">
          <div class="form-group">
            <label class="block-label" for="pubKey">Public Key</label>
            <textarea class="form-control" style="font-size:10px;" rows="10" id="pubKey"
                      placeholder="-----BEGIN PGP PUBLIC KEY BLOCK-----"></textarea>
          </div>
        </div>

        <div class="col-sm">
          <div class="form-group">
            <label class="block-label" for="plainText">Input Text</label>
            <textarea class="form-control" id="plainText" rows="5" placeholder="Secret Message"></textarea>
          </div>
          <div class="form-group progress">
            <div class="progress-bar" role="progressbar" id="encBar" style="width:100%"></div>
          </div>
          <button type="button" onclick="encryptAction()" class="btn btn-primary">Encrypt</button>
        </div>

        <div class="col-sm">
          <div class="form-group">
            <label class="block-label" for="encResult">PGP Output</label>
            <textarea class="form-control" style="font-size:10px;" rows="10" id="encResult"
                      placeholder="-----BEGIN PGP MESSAGE-----" readonly></textarea>
            <button type="button" style="margin-top:1rem;" class="btn btn-primary" data-copy="#encResult">Copy</button>
          </div>
        </div>
      </div>

      <!-- Row: DECRYPT -->
      <div class="row" style="margin-top:2rem;">
        <div class="col-12">
          <h5>Decrypt</h5>
          <div class="mini-hint">Paste an armored PGP message and your private key (with passphrase if set). Plaintext will appear on the right.</div>
          <div class="section-divider"></div>
        </div>

        <div class="col-sm">
          <div class="form-group">
            <label class="block-label" for="pgpMsg">PGP Message</label>
            <textarea class="form-control" style="font-size:10px;" rows="10" id="pgpMsg"
                      placeholder="-----BEGIN PGP MESSAGE-----"></textarea>
          </div>
          <div class="form-group">
            <label class="block-label" for="privKey">PGP Private Key</label>
            <textarea class="form-control" style="font-size:10px;" rows="10" id="privKey"
                      placeholder="-----BEGIN PGP PRIVATE KEY BLOCK-----"></textarea>
          </div>
        </div>

        <div class="col-sm">
          <div class="form-group">
            <label class="block-label" for="pass">Passphrase (if set)</label>
            <input type="password" class="form-control" id="pass" placeholder="Enter passphrase">
          </div>
          <div class="form-group progress">
            <div class="progress-bar" role="progressbar" id="decBar" style="width:100%"></div>
          </div>
          <button type="button" onclick="decryptAction()" class="btn btn-primary">Decrypt</button>
        </div>

        <div class="col-sm">
          <div class="form-group">
            <label class="block-label" for="decResult">Message</label>
            <textarea class="form-control" rows="10" id="decResult" placeholder="Secret Message" readonly></textarea>
            <button type="button" style="margin-top:1rem;" class="btn btn-primary" data-copy="#decResult">Copy</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function encryptAction() {
        const bar = document.getElementById("encBar");
        bar.className = "progress-bar progress-bar-striped progress-bar-animated";
        try {
          const pubKeyArmored = document.getElementById("pubKey").value;
          const text = document.getElementById("plainText").value;

          const publicKey = await openpgp.readKey({ armoredKey: pubKeyArmored });
          const message = await openpgp.createMessage({ text });
          const armoredMessage = await openpgp.encrypt({ message, encryptionKeys: publicKey });

          document.getElementById("encResult").value = armoredMessage;
          bar.className = "progress-bar bg-success";
        } catch (err) {
          document.getElementById("encResult").value = (err && err.message) ? err.message : String(err);
          bar.className = "progress-bar bg-danger";
        }
      }

      async function decryptAction() {
        const bar = document.getElementById("decBar");
        bar.className = "progress-bar progress-bar-striped progress-bar-animated";
        try {
          const armoredMessage = document.getElementById("pgpMsg").value;
          const privKeyArmored = document.getElementById("privKey").value;
          const pass = document.getElementById("pass").value;

          const message = await openpgp.readMessage({ armoredMessage });
          const privateKey = await openpgp.readPrivateKey({ armoredKey: privKeyArmored });
          const decryptionKeys = pass
            ? await openpgp.decryptKey({ privateKey, passphrase: pass })
            : privateKey;

          const { data } = await openpgp.decrypt({ message, decryptionKeys });

          document.getElementById("decResult").value = data;
          bar.className = "progress-bar bg-success";
        } catch (err) {
          document.getElementById("decResult").value = (err && err.message) ? err.message : String(err);
          bar.className = "progress-bar bg-danger";
        }
      }
    </script>

    <script>
      (function(){
        try {
          if (location.protocol === 'file:') {
            console.warn('[browserPGP] This page is opened via file://. Some browsers disable WebCrypto in this mode. Prefer http://localhost or HTTPS.');
          }
        } catch(_) {}
      })();
    </script>
  </body>
</html>
